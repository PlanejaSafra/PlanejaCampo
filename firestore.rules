rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // 1. COLLECTIONS PÚBLICAS (SOMENTE LEITURA PARA O APP)
    // =========================================================================
    // O App só lê. Quem escreve aqui é o seu Backend (Cloud Functions) via Admin SDK.
    
    match /rainfall_stats/{geoHash} { 
      allow read: if request.auth != null; // Todos leem
      allow write: if false;               // NINGUÉM escreve pelo App (Segurança Crítica)
    }

    // Outras tabelas de apoio (se existirem no futuro)
    match /regions/{regionId} { 
      allow read: if request.auth != null; 
      allow write: if false; 
    }

    // =========================================================================
    // 2. REGRA GERAL (FAIL-SAFE) - DADOS PRIVADOS
    // =========================================================================
    // Aplica-se a 'users', 'rainfall_data', 'properties' e qualquer nova coleção.
    // Lógica: Se tem 'userId', o dono manda. Se não tem, ninguém acessa por aqui.

    match /{collection}/{document=**} {
      
      // CRIAR: Obrigatório estar logado E enviar o campo 'userId' com seu próprio UID
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      // LER: Obrigatório estar logado E o documento ter 'userId' igual ao seu UID
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;

      // ATUALIZAR: 
      // 1. Dono bate com o UID
      // 2. NÃO está tentando transferir o documento para outra pessoa (mudar o userId)
      allow update: if request.auth != null
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == request.auth.uid;

      // DELETAR: Só o dono pode deletar
      allow delete: if request.auth != null
                    && resource.data.userId == request.auth.uid;
    }
  }
}
