rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ====================
    // User Cloud Data (agro_core identity system)
    // ====================
    match /users/{userId} {
      // Users can only read/write their own data
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ====================
    // Rainfall Data Collection (Write-Only for Users)
    // ====================
    match /rainfall_data/{geoHash5}/records/{recordId} {
      // Allow authenticated users to write anonymized rainfall data
      allow create: if request.auth != null
                    && isValidRainfallRecord(request.resource.data)
                    && !hasExceededDailyWriteLimit();

      // Deny direct reads of individual records (privacy protection)
      allow read: if false;

      // Deny updates and deletes (immutable records)
      allow update, delete: if false;
    }

    // ====================
    // Regional Statistics (Read-Only for Users)
    // ====================
    match /rainfall_stats/{geoHash} {
      // Allow authenticated users to read aggregated statistics
      allow read: if request.auth != null
                  && meetsKAnonymityThreshold(resource.data);

      // Deny writes (only Cloud Functions can update aggregates)
      allow write: if false;
    }

    // ====================
    // Helper Functions
    // ====================

    // Validate rainfall record structure and data
    function isValidRainfallRecord(data) {
      return data.keys().hasAll(['mm', 'date', 'lat', 'lon', 'geohash5', 'geohash4', 'geohash3'])
          && data.mm is number
          && data.mm >= 0
          && data.mm <= 500  // Max realistic rainfall per day
          && data.date is timestamp
          && data.lat is number
          && data.lon is number
          && data.geohash5 is string
          && data.geohash5.size() == 5
          && data.geohash4 is string
          && data.geohash4.size() == 4
          && data.geohash3 is string
          && data.geohash3.size() == 3;
    }

    // Check if user has exceeded daily write limit (10 writes/day)
    // Note: This is simplified. In production, use a separate rate-limiting collection.
    function hasExceededDailyWriteLimit() {
      // For MVP, we trust client-side rate limiting
      // Production: Implement server-side counter using a separate collection
      return false;
    }

    // Check if aggregate data meets K-Anonymity threshold (minimum 3 contributors)
    function meetsKAnonymityThreshold(data) {
      return data.count >= 3;
    }
  }
}
